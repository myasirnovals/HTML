<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pengenalan Mineral - Desktop Game</title>
    <style>
        :root {
            --bg: #0f1222;
            --bg-soft: #171a2e;
            --card: #1c2040;
            --card-2: #1a1f38;
            --fg: #e6e9ff;
            --muted: #a4a8cf;
            --primary: #7c9cff;
            --primary-2: #9eb2ff;
            --accent: #36e1a5;
            --danger: #ff6b6b;
            --warning: #ffcf66;
            --shadow: 0 10px 30px rgba(0,0,0,.35);
            --radius: 14px;
            --radius-sm: 10px;
            --radius-lg: 22px;
            --gap: 16px;
            --gap-lg: 24px;
        }
        [data-theme="light"] {
            --bg: #f6f7fb;
            --bg-soft: #fff;
            --card: #ffffff;
            --card-2: #f2f4ff;
            --fg: #1c2142;
            --muted: #58608f;
            --primary: #4057ff;
            --primary-2: #2645ff;
            --accent: #0fb77a;
            --danger: #dd2e44;
            --warning: #f0a400;
            --shadow: 0 10px 28px rgba(15,18,34,.12);
        }
        * { box-sizing: border-box }
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: radial-gradient(1200px 700px at 80% -10%, rgba(124,156,255,.14), transparent 60%),
            radial-gradient(900px 600px at -10% 110%, rgba(54,225,165,.15), transparent 60%),
            var(--bg);
            color: var(--fg);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.5;
        }
        h1,h2,h3 { margin: 0 0 8px }
        p { color: var(--muted) }
        a { color: var(--primary) }

        /* App container / screen system */
        #app { min-height: 100vh }
        .screen {
            display: none;
            min-height: 100vh;
            padding: 32px;
            position: relative;
            max-width: 1180px;
            margin: 0 auto;
        }
        .screen.active { display: block; animation: fadeIn .3s ease }
        @keyframes fadeIn { from{opacity:.01; transform: translateY(6px)} to{opacity:1; transform:none} }

        .panel {
            background: linear-gradient(180deg, var(--card), var(--card-2));
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 28px;
            border: 1px solid rgba(255,255,255,.06);
        }
        .muted { color: var(--muted) }

        .btn {
            --btn-bg: var(--primary);
            --btn-fg: white;
            padding: 12px 18px;
            border-radius: 12px;
            font-weight: 700;
            border: none;
            background: linear-gradient(180deg, var(--btn-bg), color-mix(in oklab, var(--btn-bg) 86%, black));
            color: var(--btn-fg);
            cursor: pointer;
            box-shadow: 0 6px 16px color-mix(in oklab, var(--btn-bg) 30%, transparent);
            transition: transform .08s ease, filter .2s ease, box-shadow .2s ease;
        }
        .btn:hover { filter: brightness(1.05) }
        .btn:active { transform: translateY(1px) }
        .btn.secondary {
            --btn-bg: #2a305a; --btn-fg: var(--fg);
            background: linear-gradient(180deg, #2a305a, #23284c);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 6px 16px rgba(0,0,0,.25);
        }
        .btn.ghost {
            background: transparent;
            border: 1px solid rgba(255,255,255,.16);
            color: var(--fg);
            box-shadow: none;
        }
        .btn.warning { --btn-bg: var(--warning) }
        .btn.danger { --btn-bg: var(--danger) }

        .btn[disabled], .disabled { opacity: .5; pointer-events: none; filter: grayscale(.2) }

        /* Halaman 1: Disclaimer */
        .disclaimer-wrap {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 28px;
            align-items: stretch;
            margin-top: 42px;
        }
        .disclaimer-side {
            display: flex; flex-direction: column; justify-content: center; gap: 16px;
        }
        .tos-box {
            height: 380px; overflow: auto; padding: 18px; border-radius: 12px;
            background: color-mix(in oklab, var(--bg-soft) 80%, black 10%);
            border: 1px solid rgba(255,255,255,.06);
        }
        .tos-consent {
            display: flex; align-items: center; gap: 12px; margin-top: 16px;
        }
        .tos-consent input { transform: scale(1.2) }

        /* Halaman 2: Start */
        .start-wrap { display: grid; grid-template-rows: auto 1fr auto; gap: 24px; align-items: center; min-height: calc(100vh - 64px) }
        .title-xl {
            font-size: 54px; letter-spacing: .5px; font-weight: 900;
            background: linear-gradient(90deg, var(--fg), var(--primary));
            -webkit-background-clip: text; background-clip: text; color: transparent;
            text-shadow: 0 10px 30px rgba(124,156,255,.12);
            margin-top: 20px;
        }
        .start-center {
            display: grid; place-items: center; gap: 18px;
        }
        .map-card {
            width: 900px; max-width: 100%; aspect-ratio: 16/8;
            background: linear-gradient(180deg, #0b2b4b, #091a2f);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,.06);
            padding: 18px;
            position: relative;
            overflow: hidden;
        }
        .map-card .water {
            position: absolute; inset: 0;
            background: radial-gradient(900px 220px at 30% 40%, rgba(124,156,255,.18), transparent 60%),
            radial-gradient(700px 240px at 80% 70%, rgba(54,225,165,.14), transparent 60%);
            pointer-events: none;
        }
        .map-svg { width: 100%; height: 100% }
        .map-island { fill: #2cb67d; stroke: #0c4d3f; stroke-width: 2; filter: drop-shadow(0 6px 10px rgba(0,0,0,.35)) }
        .map-island:hover { fill: #36e1a5 }
        .start-actions { display: flex; gap: 12px; justify-content: center }

        /* Halaman 3: Menu Utama */
        .menu-head { margin: 8px 0 18px }
        .card-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 18px; margin-top: 10px;
        }
        .card {
            background: linear-gradient(180deg, var(--card), var(--card-2));
            border: 1px solid rgba(255,255,255,.06);
            border-radius: var(--radius);
            padding: 18px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
            position: relative;
            overflow: hidden;
            min-height: 160px;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 14px 36px rgba(0,0,0,.35);
            border-color: rgba(124,156,255,.35);
        }
        .card .icon {
            font-size: 28px; width: 48px; height: 48px; display: grid; place-items: center;
            background: color-mix(in oklab, var(--primary) 30%, transparent);
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 12px; margin-bottom: 10px;
        }
        .card p { margin-top: 6px }

        .fab {
            position: fixed;
            bottom: 22px;
            width: 58px; height: 58px; border-radius: 16px;
            display: grid; place-items: center; font-size: 20px;
            background: linear-gradient(180deg, #293062, #1e2450);
            color: var(--fg); border: 1px solid rgba(255,255,255,.1);
            box-shadow: var(--shadow); cursor: pointer;
        }
        .fab-left { left: max(22px, calc((100vw - 1180px)/2 + 8px)) }
        .fab-right { right: max(22px, calc((100vw - 1180px)/2 + 8px)) }
        .fab:hover { filter: brightness(1.08) }
        .fab.danger { background: linear-gradient(180deg, #81333c, #5f2026) }

        /* Halaman 4: Kamus Mineral */
        .back-btn {
            position: absolute; top: 22px; left: 22px; z-index: 2;
        }
        .kamus-wrap { display: grid; grid-template-columns: 320px 1fr; gap: 18px; margin-top: 18px }
        .mineral-list { border-radius: var(--radius); background: linear-gradient(180deg, var(--card), var(--card-2)); border: 1px solid rgba(255,255,255,.06); box-shadow: var(--shadow); overflow: hidden }
        .mineral-list .head { padding: 16px 16px 10px; border-bottom: 1px solid rgba(255,255,255,.06) }
        .mineral-list input {
            width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12);
            background: #101535; color: var(--fg);
        }
        .mineral-items { list-style: none; margin: 0; padding: 8px; max-height: calc(100vh - 220px); overflow: auto }
        .mineral-items li {
            padding: 12px 12px; border-radius: 10px; cursor: pointer; transition: background .15s ease, transform .05s ease;
            display: flex; align-items: center; gap: 10px;
        }
        .mineral-items li:hover { background: rgba(124,156,255,.1) }
        .mineral-items li.active { background: rgba(124,156,255,.18); border: 1px solid rgba(124,156,255,.4) }
        .badge { font-size: 12px; color: var(--primary); background: rgba(124,156,255,.18); padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(124,156,255,.35) }

        .mineral-detail {
            position: relative;
            border-radius: var(--radius);
            background: linear-gradient(180deg, var(--card), var(--card-2));
            border: 1px solid rgba(255,255,255,.06);
            box-shadow: var(--shadow);
            padding: 18px;
            min-height: calc(100vh - 150px);
            overflow: hidden;
        }
        .detail-scroll { position: absolute; inset: 18px 18px 72px 18px; overflow: auto; padding-right: 6px }
        .detail-scroll h2 { margin-bottom: 6px }
        .kv { display: grid; grid-template-columns: 140px 1fr; gap: 6px 12px; margin: 10px 0 16px }
        .kv .k { color: var(--muted) }
        .divider { height: 1px; background: rgba(255,255,255,.08); margin: 12px 0 16px }

        .speak-btn {
            position: absolute; left: 18px; bottom: 18px; z-index: 3;
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,.12);
            background: linear-gradient(180deg, #194a3e, #143a31);
            color: #eafff6; cursor: pointer; box-shadow: var(--shadow);
        }
        .speak-btn.playing { background: linear-gradient(180deg, #1f6f5c, #1a5a4b) }

        /* Placeholder pages */
        .placeholder {
            display: grid; place-items: center; min-height: calc(100vh - 120px);
            border-radius: var(--radius-lg);
            background: linear-gradient(180deg, var(--card), var(--card-2));
            border: 1px solid rgba(255,255,255,.06);
            box-shadow: var(--shadow);
        }
        .placeholder .inner { text-align: center; max-width: 680px; padding: 28px }
        .placeholder h2 { font-size: 30px; margin-bottom: 8px }

        /* Modals */
        .modal {
            position: fixed; inset: 0; display: grid; place-items: center; background: rgba(6,8,18,.52);
            z-index: 50; padding: 20px;
        }
        .modal.hidden { display: none }
        .modal .box {
            width: 560px; max-width: 100%;
            background: linear-gradient(180deg, var(--card), var(--card-2));
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 16px; box-shadow: var(--shadow);
            padding: 20px;
        }
        .modal .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 0 }
        .modal .actions { display: flex; justify-content: flex-end; gap: 10px; padding-top: 10px }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .card, .btn, .screen.active { animation: none; transition: none }
        }
    </style>
</head>
<body>
<div id="app">
    <!-- Halaman 1: Disclaimer + TOS -->
    <section id="screen-disclaimer" class="screen active">
        <div class="panel">
            <h1>Disclaimer</h1>
            <p class="muted">Aplikasi ini ditujukan untuk keperluan edukasi dan demonstrasi. Beberapa data bersifat ringkasan dan mungkin tidak sepenuhnya mewakili detail ilmiah lengkap.</p>
            <div class="disclaimer-wrap">
                <div class="disclaimer-side">
                    <ul>
                        <li>Konten mineral merujuk pada karakteristik umum (warna, kekerasan, kegunaan).</li>
                        <li>Hasil dan visualisasi bersifat simulasi dan bukan alat profesional.</li>
                        <li>Kami tidak menyimpan data pribadi Anda.</li>
                    </ul>
                    <div>
                        <div class="tos-box">
                            <h3>Syarat Layanan (Terms of Service)</h3>
                            <ol>
                                <li>Gunakan aplikasi secara wajar untuk pembelajaran.</li>
                                <li>Jangan menyalahgunakan konten untuk klaim komersial tanpa verifikasi.</li>
                                <li>Tidak ada jaminan kelayakan untuk tujuan tertentu.</li>
                                <li>Dukungan suara menggunakan Speech Synthesis dari browser (jika tersedia).</li>
                            </ol>
                            <p class="muted">Dengan melanjutkan, Anda menyetujui syarat di atas.</p>
                        </div>
                        <label class="tos-consent">
                            <input type="checkbox" id="tosCheck" />
                            <span>Saya telah membaca dan setuju dengan Terms of Service</span>
                        </label>
                        <div style="display:flex; gap:10px; margin-top:10px">
                            <button class="btn" id="btnToStart" disabled>Lanjut</button>
                            <button class="btn ghost" id="btnQuitFromTos">Keluar</button>
                        </div>
                    </div>
                </div>
                <div class="panel" style="min-height: 420px; display: grid; place-items: center;">
                    <div>
                        <h3>Tips</h3>
                        <ul>
                            <li>Gunakan tombol Pengaturan (pojok kiri bawah di menu) untuk tema dan kecepatan suara.</li>
                            <li>Klik mineral di daftar untuk melihat detailnya.</li>
                            <li>Gunakan tombol speaker di pojok kiri bawah kolom detail untuk mendengarkan penjelasan.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Halaman 2: Start -->
    <section id="screen-start" class="screen">
        <div class="start-wrap">
            <div>
                <div class="title-xl">pengenalan mineral</div>
                <p class="muted">Mulai perjalanan mengenal mineral dengan cara yang interaktif.</p>
            </div>
            <div class="start-center">
                <div class="map-card">
                    <div class="water"></div>
                    <!-- Pulau Indonesia (SVG sederhana) -->
                    <svg class="map-svg" viewBox="0 0 800 300" aria-label="Pulau-pulau Indonesia">
                        <!-- Sumatra -->
                        <polygon class="map-island" points="80,170 120,130 170,110 220,120 240,140 210,180 160,200 110,190" />
                        <!-- Jawa -->
                        <polygon class="map-island" points="220,230 360,230 370,240 230,245" />
                        <!-- Bali & Nusa Tenggara -->
                        <polygon class="map-island" points="380,238 395,238 395,244 380,244" />
                        <polygon class="map-island" points="405,240 430,240 430,246 405,246" />
                        <polygon class="map-island" points="442,242 468,242 468,248 442,248" />
                        <!-- Kalimantan -->
                        <polygon class="map-island" points="290,80 360,60 440,90 410,150 330,140 300,110" />
                        <!-- Sulawesi -->
                        <polygon class="map-island" points="470,110 520,100 560,120 520,140 500,130" />
                        <polygon class="map-island" points="520,140 560,160 540,180 500,150" />
                        <!-- Papua -->
                        <polygon class="map-island" points="610,100 720,100 760,140 720,180 640,160 600,120" />
                    </svg>
                </div>
                <div class="start-actions">
                    <button class="btn" id="btnGoMenu">Mulai</button>
                    <button class="btn secondary" id="btnBackToTos">Kembali</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Halaman 3: Menu Utama -->
    <section id="screen-menu" class="screen">
        <div class="menu-head">
            <h1>Menu Utama</h1>
            <p class="muted">Pilih mode yang kamu inginkan.</p>
        </div>
        <div class="card-grid">
            <div class="card" data-target="kamus" role="button" tabindex="0" aria-label="Kamus Mineral">
                <div class="icon">üìò</div>
                <h3>Kamus Mineral</h3>
                <p class="muted">Lihat deskripsi, sifat, serta kegunaan mineral umum.</p>
            </div>
            <div class="card" data-target="panduan" role="button" tabindex="0" aria-label="Panduan">
                <div class="icon">üìñ</div>
                <h3>Panduan</h3>
                <p class="muted">Pelajari cara identifikasi mineral dengan mudah.</p>
            </div>
            <div class="card" data-target="challenge" role="button" tabindex="0" aria-label="Challenge">
                <div class="icon">üèÜ</div>
                <h3>Challenge</h3>
                <p class="muted">Uji pengetahuanmu melalui tantangan singkat.</p>
            </div>
            <div class="card" data-target="map" role="button" tabindex="0" aria-label="Map Eksplorasi">
                <div class="icon">üó∫Ô∏è</div>
                <h3>Map Eksplorasi</h3>
                <p class="muted">Jelajah lokasi dan temukan potensi mineral.</p>
            </div>
        </div>

        <!-- FABs -->
        <button id="btnSettings" class="fab fab-left" title="Pengaturan" aria-label="Pengaturan">‚öôÔ∏è</button>
        <button id="btnExit" class="fab fab-right danger" title="Keluar" aria-label="Keluar">‚õî</button>
    </section>

    <!-- Halaman 4: Kamus Mineral -->
    <section id="screen-kamus" class="screen">
        <button class="btn ghost back-btn" data-back="menu">‚¨Ö Kembali ke Menu</button>

        <div style="padding-left: 120px">
            <h1>Kamus Mineral</h1>
            <p class="muted">Klik salah satu mineral di kiri untuk melihat detailnya.</p>
        </div>

        <div class="kamus-wrap">
            <!-- Kolom 1: daftar mineral -->
            <aside class="mineral-list">
                <div class="head">
                    <strong>Daftar Mineral</strong>
                    <div style="height:8px"></div>
                    <input type="search" id="searchMineral" placeholder="Cari mineral..." />
                </div>
                <ul class="mineral-items" id="mineralList"></ul>
            </aside>

            <!-- Kolom 2: detail mineral -->
            <section class="mineral-detail">
                <div class="detail-scroll">
                    <h2 id="mineralTitle">Belum ada mineral dipilih</h2>
                    <p id="mineralIntro" class="muted">Pilih mineral di samping untuk menampilkan penjelasan.</p>
                    <div class="divider"></div>
                    <div class="kv">
                        <div class="k">Nama</div><div id="kv-nama">-</div>
                        <div class="k">Rumus</div><div id="kv-rumus">-</div>
                        <div class="k">Kekerasan (Mohs)</div><div id="kv-kekerasan">-</div>
                        <div class="k">Warna</div><div id="kv-warna">-</div>
                        <div class="k">Ciri Khas</div><div id="kv-ciri">-</div>
                        <div class="k">Kegunaan</div><div id="kv-guna">-</div>
                    </div>
                    <div class="divider"></div>
                    <div>
                        <h3>Penjelasan</h3>
                        <p id="mineralDesc" class="muted">‚Äî</p>
                    </div>
                </div>

                <!-- Speaker di pojok kiri bawah kolom 2 -->
                <button id="btnSpeak" class="speak-btn" title="Dengarkan penjelasan">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M4 9v6h4l5 4V5L8 9H4z" fill="#eafff6"/>
                        <path d="M16.5 8.5a5 5 0 010 7" stroke="#eafff6" stroke-width="2" stroke-linecap="round"/>
                        <path d="M18.5 6a8 8 0 010 12" stroke="#eafff6" stroke-width="2" stroke-linecap="round" opacity=".7"/>
                    </svg>
                    <span id="speakLabel">Dengarkan</span>
                </button>
            </section>
        </div>
    </section>

    <!-- Halaman Panduan -->
    <section id="screen-panduan" class="screen">
        <button class="btn ghost back-btn" data-back="menu">‚¨Ö Kembali ke Menu</button>
        <div class="placeholder">
            <div class="inner">
                <h2>Panduan</h2>
                <p class="muted">Gunakan skala Mohs, warna gores, dan belahan untuk mengidentifikasi mineral. Panduan lengkap akan hadir di versi berikutnya.</p>
                <div style="height:14px"></div>
                <button class="btn" data-back="menu">Kembali ke Menu</button>
            </div>
        </div>
    </section>

    <!-- Halaman Challenge -->
    <section id="screen-challenge" class="screen">
        <button class="btn ghost back-btn" data-back="menu">‚¨Ö Kembali ke Menu</button>
        <div class="placeholder">
            <div class="inner">
                <h2>Challenge</h2>
                <p class="muted">Mode kuis interaktif akan segera tersedia. Nantikan!</p>
                <div style="height:14px"></div>
                <button class="btn" data-back="menu">Kembali ke Menu</button>
            </div>
        </div>
    </section>

    <!-- Halaman Map Eksplorasi -->
    <section id="screen-map" class="screen">
        <button class="btn ghost back-btn" data-back="menu">‚¨Ö Kembali ke Menu</button>
        <div class="placeholder">
            <div class="inner">
                <h2>Map Eksplorasi</h2>
                <p class="muted">Rencanakan penjelajahan dan temukan lokasi mineral potensial. Fitur peta interaktif akan hadir kemudian.</p>
                <div style="height:14px"></div>
                <button class="btn" data-back="menu">Kembali ke Menu</button>
            </div>
        </div>
    </section>

    <!-- Modal Pengaturan -->
    <div id="settingsModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Pengaturan">
        <div class="box">
            <h3>Pengaturan</h3>
            <div class="row">
                <label for="themeSelect">Tema</label>
                <select id="themeSelect">
                    <option value="dark">Gelap</option>
                    <option value="light">Terang</option>
                </select>
            </div>
            <div class="row">
                <label for="voiceRate">Kecepatan Suara</label>
                <input id="voiceRate" type="range" min="0.6" max="1.4" step="0.1" value="1" />
            </div>
            <div class="actions">
                <button class="btn secondary" id="closeSettings">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal Exit -->
    <div id="exitModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Konfirmasi Keluar">
        <div class="box">
            <h3>Keluar dari Game?</h3>
            <p class="muted">Anda yakin ingin keluar? Perubahan yang belum disimpan akan hilang.</p>
            <div class="actions">
                <button class="btn ghost" id="cancelExit">Batal</button>
                <button class="btn danger" id="confirmExit">Keluar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // State & helpers
    const screens = {
        disclaimer: document.getElementById('screen-disclaimer'),
        start: document.getElementById('screen-start'),
        menu: document.getElementById('screen-menu'),
        kamus: document.getElementById('screen-kamus'),
        panduan: document.getElementById('screen-panduan'),
        challenge: document.getElementById('screen-challenge'),
        map: document.getElementById('screen-map'),
    };
    const showScreen = (name) => {
        Object.values(screens).forEach(s => s.classList.remove('active'));
        screens[name]?.classList.add('active');
        // Stop any speech when navigating
        stopSpeech();
    };

    // Halaman 1: TOS
    const tosCheck = document.getElementById('tosCheck');
    const btnToStart = document.getElementById('btnToStart');
    const btnQuitFromTos = document.getElementById('btnQuitFromTos');
    tosCheck.addEventListener('change', () => btnToStart.disabled = !tosCheck.checked);
    btnToStart.addEventListener('click', () => showScreen('start'));
    btnQuitFromTos.addEventListener('click', () => {
        if (confirm('Tutup aplikasi sekarang?')) window.close();
    });

    // Halaman 2: Start
    document.getElementById('btnGoMenu').addEventListener('click', () => showScreen('menu'));
    document.getElementById('btnBackToTos').addEventListener('click', () => showScreen('disclaimer'));

    // Halaman 3: Menu
    document.querySelectorAll('#screen-menu .card').forEach(card => {
        card.addEventListener('click', () => {
            const target = card.getAttribute('data-target');
            if (target && screens[target]) showScreen(target);
        });
        card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); card.click(); }
        });
    });

    // FABs
    const settingsModal = document.getElementById('settingsModal');
    const exitModal = document.getElementById('exitModal');
    document.getElementById('btnSettings').addEventListener('click', () => settingsModal.classList.remove('hidden'));
    document.getElementById('btnExit').addEventListener('click', () => exitModal.classList.remove('hidden'));
    document.getElementById('closeSettings').addEventListener('click', () => settingsModal.classList.add('hidden'));
    document.getElementById('cancelExit').addEventListener('click', () => exitModal.classList.add('hidden'));
    document.getElementById('confirmExit').addEventListener('click', () => {
        exitModal.classList.add('hidden');
        window.close();
        // Fallback:
        setTimeout(() => {
            alert('Tidak dapat menutup jendela secara otomatis. Silakan tutup tab ini secara manual.');
        }, 50);
    });

    // Back buttons
    document.querySelectorAll('[data-back]').forEach(btn => {
        btn.addEventListener('click', () => showScreen(btn.getAttribute('data-back')));
    });

    // Theme
    const themeSelect = document.getElementById('themeSelect');
    themeSelect.value = document.documentElement.getAttribute('data-theme') || 'dark';
    themeSelect.addEventListener('change', () => {
        document.documentElement.setAttribute('data-theme', themeSelect.value);
    });

    // Kamus Mineral Data
    const MINERAL_DATA = [
        {
            key: 'kuarsa', nama: 'Kuarsa', rumus: 'SiO‚ÇÇ', kekerasan: '7',
            warna: 'Bening, putih susu, beragam warna',
            ciri: 'Tidak tergores pisau; belahan tidak sempurna; kilap kaca',
            guna: 'Kaca, elektronik, bahan bangunan',
            desc: 'Kuarsa adalah salah satu mineral paling melimpah di kerak bumi. Ia kristal silikat dengan kekerasan tinggi, tahan cuaca, dan hadir dalam banyak varietas seperti ametis dan citrin.'
        },
        {
            key: 'feldspar', nama: 'Feldspar', rumus: 'K(AlSi‚ÇÉO‚Çà)‚ÄìNa(AlSi‚ÇÉO‚Çà)‚ÄìCa(Al‚ÇÇSi‚ÇÇO‚Çà)', kekerasan: '6',
            warna: 'Putih, krem, merah muda',
            ciri: 'Belahan baik dua arah; kilap kaca-ke-mutiara',
            guna: 'Keramik, kaca, filler industri',
            desc: 'Kelompok feldspar menyusun sebagian besar batuan beku. Mudah dikenali dari belahan dua arah dan warna pucatnya.'
        },
        {
            key: 'mika', nama: 'Mika (Muscovite/Biotite)', rumus: 'KAl‚ÇÇ(AlSi‚ÇÉO‚ÇÅ‚ÇÄ)(F,OH)‚ÇÇ; K(Mg,Fe)‚ÇÉ(AlSi‚ÇÉO‚ÇÅ‚ÇÄ)(OH)‚ÇÇ', kekerasan: '2‚Äì3',
            warna: 'Transparan (muscovite) hingga hitam (biotite)',
            ciri: 'Lembaran tipis elastis; belahan sangat sempurna satu arah',
            guna: 'Isolator listrik, bahan tahan panas',
            desc: 'Mika terkelupas menjadi lembaran sangat tipis. Muscovite berwarna terang, sedangkan biotite cenderung gelap.'
        },
        {
            key: 'kalsit', nama: 'Kalsit', rumus: 'CaCO‚ÇÉ', kekerasan: '3',
            warna: 'Putih, bening, beragam',
            ciri: 'Reaksi dengan HCl encer; belahan tiga arah (belah rombohedral)',
            guna: 'Semen, kapur, bahan bangunan',
            desc: 'Kalsit adalah mineral karbonat penting yang bereaksi kuat dengan asam klorida encer menghasilkan gelembung CO‚ÇÇ.'
        },
        {
            key: 'pirit', nama: 'Pirit', rumus: 'FeS‚ÇÇ', kekerasan: '6‚Äì6.5',
            warna: 'Kuning keemasan (emas palsu)',
            ciri: 'Kilap metalik, kristal kubus; berat',
            guna: 'Sumber belerang, koleksi mineral',
            desc: 'Dijuluki emas palsu karena warnanya. Pirit mudah dikenali dari kilap metalik dan habit kubusnya.'
        },
        {
            key: 'hematit', nama: 'Hematit', rumus: 'Fe‚ÇÇO‚ÇÉ', kekerasan: '5‚Äì6.5',
            warna: 'Abu-abu metalik hingga merah kecokelatan',
            ciri: 'Gores merah-cokelat; berat',
            guna: 'Bijih besi utama, pigmen',
            desc: 'Hematit adalah oksida besi penting. Meskipun tampak metalik, coretan goresnya selalu merah-cokelat.'
        },
        {
            key: 'magnetit', nama: 'Magnetit', rumus: 'Fe‚ÇÉO‚ÇÑ', kekerasan: '5.5‚Äì6.5',
            warna: 'Hitam',
            ciri: 'Bersifat magnetik; gores hitam',
            guna: 'Bijih besi, magnet alami',
            desc: 'Magnetit adalah mineral feromagnetik alami. Daya tarik magnetnya memudahkan identifikasi lapangan.'
        },
        {
            key: 'boksit', nama: 'Boksit', rumus: 'Campuran Al-hidroksida', kekerasan: '1‚Äì3',
            warna: 'Cokelat kemerahan',
            ciri: 'Berpori, seperti tanah laterit',
            guna: 'Bahan baku aluminium',
            desc: 'Boksit bukan mineral tunggal tetapi batuan kaya aluminium (gibsit, boehmit, diaspor) hasil pelapukan intensif.'
        },
        {
            key: 'gipsum', nama: 'Gipsum', rumus: 'CaSO‚ÇÑ¬∑2H‚ÇÇO', kekerasan: '2',
            warna: 'Putih, bening',
            ciri: 'Sangat lunak (tergores kuku); belahan baik',
            guna: 'GRC, drywall, plester',
            desc: 'Gipsum sangat lunak dan sering membentuk kristal serat (selenite). Banyak digunakan pada industri konstruksi.'
        },
        {
            key: 'fluorit', nama: 'Fluorit', rumus: 'CaF‚ÇÇ', kekerasan: '4',
            warna: 'Ungu, hijau, kuning, bening',
            ciri: 'Kristal kubus; fluoresensi pada UV',
            guna: 'Fluks metalurgi, bahan kimia fluor',
            desc: 'Fluorit mudah dikenali dari kristal kubusnya dan sering berfluoresensi di bawah sinar UV.'
        },
        {
            key: 'galena', nama: 'Galena', rumus: 'PbS', kekerasan: '2.5',
            warna: 'Abu-abu metalik',
            ciri: 'Sangat berat; belahan kubus sempurna',
            guna: 'Bijih utama timbal',
            desc: 'Galena merupakan mineral sulfida timbal. Kilap metalik tinggi dan massa jenis besar membuatnya khas.'
        },
        {
            key: 'talk', nama: 'Talk', rumus: 'Mg‚ÇÉSi‚ÇÑO‚ÇÅ‚ÇÄ(OH)‚ÇÇ', kekerasan: '1',
            warna: 'Putih kehijauan',
            ciri: 'Paling lunak pada skala Mohs; terasa licin',
            guna: 'Bedak, pelumas kering',
            desc: 'Talk adalah mineral paling lunak. Mudah tergores dengan kuku dan terasa licin saat disentuh.'
        }
    ];

    // Populate mineral list
    const mineralListEl = document.getElementById('mineralList');
    const searchMineral = document.getElementById('searchMineral');
    let currentMineralKey = null;

    function renderMineralList(filter = '') {
        mineralListEl.innerHTML = '';
        const term = filter.trim().toLowerCase();
        MINERAL_DATA
            .filter(m => [m.nama, m.key].join(' ').toLowerCase().includes(term))
            .forEach(m => {
                const li = document.createElement('li');
                li.setAttribute('data-key', m.key);
                li.innerHTML = `
            <span class="badge">Mohs ${m.kekerasan}</span>
            <div style="display:grid">
              <strong>${m.nama}</strong>
              <small class="muted">${m.warna}</small>
            </div>
          `;
                li.addEventListener('click', () => selectMineral(m.key));
                li.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectMineral(m.key); }
                });
                li.tabIndex = 0;
                if (m.key === currentMineralKey) li.classList.add('active');
                mineralListEl.appendChild(li);
            });
    }
    searchMineral.addEventListener('input', () => renderMineralList(searchMineral.value));
    renderMineralList();

    // Detail binding
    const elTitle = document.getElementById('mineralTitle');
    const elIntro = document.getElementById('mineralIntro');
    const KV = {
        nama: document.getElementById('kv-nama'),
        rumus: document.getElementById('kv-rumus'),
        kekerasan: document.getElementById('kv-kekerasan'),
        warna: document.getElementById('kv-warna'),
        ciri: document.getElementById('kv-ciri'),
        guna: document.getElementById('kv-guna'),
    };
    const elDesc = document.getElementById('mineralDesc');

    function selectMineral(key) {
        const m = MINERAL_DATA.find(x => x.key === key);
        if (!m) return;
        currentMineralKey = key;
        // Update active state
        document.querySelectorAll('#mineralList li').forEach(li => {
            li.classList.toggle('active', li.getAttribute('data-key') === key);
        });
        // Update details
        elTitle.textContent = m.nama;
        elIntro.textContent = m.warna;
        KV.nama.textContent = m.nama;
        KV.rumus.textContent = m.rumus;
        KV.kekerasan.textContent = m.kekerasan;
        KV.warna.textContent = m.warna;
        KV.ciri.textContent = m.ciri;
        KV.guna.textContent = m.guna;
        elDesc.textContent = m.desc;

        // Stop previous speech if any
        stopSpeech();
        document.getElementById('speakLabel').textContent = 'Dengarkan';
        document.getElementById('btnSpeak').classList.remove('playing');
    }

    // Speech synthesis
    const btnSpeak = document.getElementById('btnSpeak');
    const speakLabel = document.getElementById('speakLabel');
    const voiceRate = document.getElementById('voiceRate');
    let speaking = false;

    function stopSpeech() {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            speaking = false;
            btnSpeak?.classList.remove('playing');
            speakLabel.textContent = 'Dengarkan';
        }
    }

    function speakMineral() {
        if (!currentMineralKey) return;
        const m = MINERAL_DATA.find(x => x.key === currentMineralKey);
        if (!m) return;

        if (!('speechSynthesis' in window)) {
            alert('Fitur suara tidak didukung di browser ini.');
            return;
        }
        if (speaking) {
            stopSpeech();
            return;
        }

        const text = [
            `${m.nama}.`,
            `Rumus kimia: ${m.rumus}.`,
            `Kekerasan skala Mohs: ${m.kekerasan}.`,
            `Warna umum: ${m.warna}.`,
            `Ciri khas: ${m.ciri}.`,
            `Kegunaan: ${m.guna}.`,
            m.desc
        ].join(' ');

        const uttr = new SpeechSynthesisUtterance(text);
        uttr.lang = 'id-ID'; // fallback ke default jika tidak tersedia
        uttr.rate = parseFloat(voiceRate.value || '1');
        uttr.onend = () => { speaking = false; btnSpeak.classList.remove('playing'); speakLabel.textContent = 'Dengarkan'; };
        uttr.onerror = () => { speaking = false; btnSpeak.classList.remove('playing'); speakLabel.textContent = 'Dengarkan'; };
        speaking = true;
        btnSpeak.classList.add('playing');
        speakLabel.textContent = 'Hentikan';
        window.speechSynthesis.speak(uttr);
    }

    btnSpeak.addEventListener('click', speakMineral);

    // Keyboard: Esc to close modals / stop speech
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (!settingsModal.classList.contains('hidden')) { settingsModal.classList.add('hidden'); return; }
            if (!exitModal.classList.contains('hidden')) { exitModal.classList.add('hidden'); return; }
            stopSpeech();
        }
    });

    // Start pada mineral pertama saat masuk ke Kamus (opsional)
    screens.kamus.addEventListener('transitionend', () => {
        if (screens.kamus.classList.contains('active') && !currentMineralKey) {
            selectMineral(MINERAL_DATA[0].key);
        }
    });
</script>
</body>
</html>